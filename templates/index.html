<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>OwlSense æ­æ–¯æƒ…ç·’é™ªä¼´æ©Ÿå™¨äºº</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --color-bg-gradient-start: #e5ddff;
      --color-bg-gradient-end: #d0ecff;
      --color-primary: #6c5ce7;   /* ç™‚ç™’ç´« */
      --color-secondary: #4ea8de; /* æŸ”å’Œè— */
      --color-card-bg: #ffffff;
      --color-user-bubble: #dfe7fd;
      --color-bot-bubble: #f1f3f5;
      --color-text: #333;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC",
        "Segoe UI", sans-serif;
      color: var(--color-text);
      background: linear-gradient(
        145deg,
        var(--color-bg-gradient-start),
        var(--color-bg-gradient-end)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app-wrapper {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 20px;
    }

    @media (max-width: 800px) {
      .app-wrapper {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--color-card-bg);
      border-radius: 24px;
      box-shadow: 0 18px 45px rgba(50, 50, 93, 0.15);
      padding: 20px 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .owl-logo {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffffff, var(--color-primary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
      flex-shrink: 0;
    }

    .header-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title {
      font-size: 1.3rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(108, 92, 231, 0.08);
      color: var(--color-primary);
      border: 1px solid rgba(108, 92, 231, 0.35);
    }

    .subtitle {
      font-size: 0.86rem;
      color: #5c5c7a;
    }

    .user-id-bar {
      font-size: 0.8rem;
      color: #6c757d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .safety-note {
      font-size: 0.78rem;
      color: #6c757d;
      border-radius: 12px;
      background: #f8f9fa;
      padding: 8px 10px;
      display: flex;
      gap: 6px;
      align-items: flex-start;
    }

    .safety-note-icon {
      font-size: 1rem;
      margin-top: 1px;
    }

    .chat-box {
      flex: 1;
      border-radius: 18px;
      background: #f7f7fb;
      padding: 10px 10px 12px;
      overflow-y: auto;
      max-height: 520px;
    }

    .message-row {
      margin: 6px 0;
      display: flex;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-row.bot {
      justify-content: flex-start;
    }

    .bubble {
      max-width: 80%;
      padding: 8px 11px;
      border-radius: 16px;
      font-size: 0.9rem;
      line-height: 1.4;
      position: relative;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.user-bubble {
      background: var(--color-user-bubble);
      border-bottom-right-radius: 2px;
    }

    .bubble.bot-bubble {
      background: var(--color-bot-bubble);
      border-bottom-left-radius: 2px;
    }

    .bubble-meta {
      font-size: 0.7rem;
      color: #868e96;
      margin-top: 2px;
    }

    .input-area {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    textarea {
      width: 100%;
      min-height: 56px;
      max-height: 120px;
      border-radius: 16px;
      border: 1px solid #ced4da;
      padding: 10px 36px 10px 12px;
      font-size: 0.95rem;
      resize: vertical;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.15);
    }

    .input-placeholder-tag {
      position: absolute;
      right: 10px;
      bottom: 8px;
      font-size: 0.7rem;
      color: #adb5bd;
    }

    button {
      border: none;
      border-radius: 16px;
      padding: 10px 18px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 20px rgba(108, 92, 231, 0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s;
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(108, 92, 231, 0.4);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 15px rgba(108, 92, 231, 0.25);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .right-panel-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: #444;
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tag {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(108, 92, 231, 0.08);
      color: #5f3dc4;
      border: 1px solid rgba(108, 92, 231, 0.18);
    }

    .tip-card {
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 0.82rem;
      color: #555;
      border: 1px solid rgba(0, 0, 0, 0.02);
    }

    .tip-card h3 {
      margin: 0 0 4px;
      font-size: 0.86rem;
      color: #495057;
    }

    .tip-list {
      padding-left: 18px;
      margin: 4px 0 0;
    }

    .tip-list li {
      margin: 2px 0;
    }

    .footer-note {
      font-size: 0.75rem;
      color: #868e96;
      margin-top: 4px;
    }

    /* æš±ç¨±å½ˆçª— */
    #nickname-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    #nickname-modal .modal-inner {
      background: #ffffff;
      padding: 20px 20px 16px;
      border-radius: 20px;
      width: 320px;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    #nickname-modal p {
      margin: 0 0 8px;
      font-size: 0.95rem;
    }

    #nickname-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ced4da;
      font-size: 0.9rem;
      margin-top: 6px;
    }

    #save-nickname {
      margin-top: 12px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: white;
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <!-- å·¦ï¼šèŠå¤©ä¸»å€ -->
    <div class="card">
      <div class="header">
        <div class="owl-logo">ğŸ¦‰</div>
        <div class="header-text">
          <div class="title">
            OwlSense æ­æ–¯
            <span class="badge">æ ¡åœ’æƒ…ç·’é™ªä¼´æ©Ÿå™¨äºº</span>
          </div>
          <div class="subtitle">
            æƒ³èªªä»€éº¼éƒ½å¯ä»¥ï¼Œè®“æ­æ–¯é™ªä½ ä¸€èµ·æ•´ç†å¿ƒæƒ…ã€‚æ…¢æ…¢ä¾†å°±å¥½ï¼Œä¸ç”¨ä¸€æ¬¡èªªå®Œã€‚
          </div>
        </div>
      </div>

      <div class="user-id-bar">
        <span id="nickname-label">æš±ç¨±ï¼šå°šæœªè¨­å®š</span>
        <span id="anon-id-label">åŒ¿åä»£è™Ÿï¼šOwl#000</span>
      </div>

      <div class="safety-note">
        <div class="safety-note-icon">ğŸ«¶</div>
        <div>
          æ­æ–¯åªæ˜¯ä¸€å€‹é™ªä½ èŠèŠå¤©ã€å¹«ä½ æ•´ç†å¿ƒæƒ…çš„æ©Ÿå™¨äººï¼Œä¸èƒ½ä»£æ›¿è€å¸«æˆ–é†«ç”Ÿã€‚
          å¦‚æœæœ‰å¾ˆåš´é‡çš„ä¸èˆ’æœã€æƒ³å‚·å®³è‡ªå·±æˆ–è¢«åˆ¥äººå‚·å®³ï¼Œä¸€å®šè¦ç«‹åˆ»è·Ÿä¿¡ä»»çš„å¤§äººèªªï¼Œ
          ä¾‹å¦‚å°å¸«ã€è¼”å°è€å¸«æˆ–å®¶äººã€‚
        </div>
      </div>

      <div id="chat-box" class="chat-box">
        <!-- åˆå§‹å•å€™ -->
        <div class="message-row bot">
          <div>
            <div class="bubble bot-bubble">
              å—¨ï¼Œæˆ‘æ˜¯ ğŸ¦‰ æ­æ–¯ã€‚<br>
              åœ¨é–‹å§‹ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆå•å•ä½ ï¼šæˆ‘å¯ä»¥æ€éº¼ç¨±å‘¼ä½ å‘¢ï¼Ÿ<br><br>
              ä½ å¯ä»¥å¹«è‡ªå·±å–ä¸€å€‹æš±ç¨±ï¼Œä¾‹å¦‚ã€Œå°æ¨¹ã€ã€ã€Œæ˜Ÿæ˜Ÿã€æˆ–ä»»ä½•ä½ å–œæ­¡çš„åå­—ã€‚<br>
              ä¹‹å¾Œæˆ‘å°±æœƒç”¨é€™å€‹æš±ç¨±è·Ÿä½ èªªè©±ã€‚
            </div>
            <div class="bubble-meta">æ­æ–¯</div>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <textarea id="user-input" placeholder="å…ˆå¹«è‡ªå·±å–å€‹æš±ç¨±ï¼Œç„¶å¾Œå†è·Ÿæ­æ–¯èªªèªªä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹å§ã€‚"></textarea>
          <div class="input-placeholder-tag">æŒ‰ Enter é€å‡ºï¼ŒShift+Enter æ›è¡Œ</div>
        </div>
        <button id="send-btn">
          å‚³çµ¦æ­æ–¯
        </button>
      </div>
    </div>

    <!-- å³ï¼šå°æé†’ & ä½¿ç”¨èªªæ˜ -->
    <div class="card">
      <div class="right-panel-title">å¦‚ä½•è·Ÿ ğŸ¦‰ æ­æ–¯èŠèŠï¼Ÿ</div>
      <div class="tag-list">
        <div class="tag">æˆ‘ä»Šå¤©å¿ƒæƒ…æ€ªæ€ªçš„</div>
        <div class="tag">æˆ‘è·ŸåŒå­¸åµæ¶äº†</div>
        <div class="tag">è¦ºå¾—å¾ˆç´¯ã€ä¸æƒ³ä¸Šå­¸</div>
        <div class="tag">è¦ºå¾—è‡ªå·±å¾ˆæ²’ç”¨</div>
      </div>

      <div class="tip-card">
        <h3>å¯ä»¥è·Ÿæ­æ–¯èªªäº›ä»€éº¼ï¼Ÿ</h3>
        <ul class="tip-list">
          <li>ä»Šå¤©ç™¼ç”Ÿä»€éº¼äº‹ï¼Œè®“ä½ å°è±¡å¾ˆæ·±ï¼Ÿ</li>
          <li>å¿ƒè£¡æœ€é‡çš„é‚£å€‹æ„Ÿè¦ºæ˜¯ä»€éº¼ï¼Ÿï¼ˆç”Ÿæ°£ã€é›£éã€å®³æ€•â€¦ï¼‰</li>
          <li>æœ‰æ²’æœ‰ä¸€ä»¶äº‹æƒ…ï¼Œè®“ä½ è¦ºå¾—ç‰¹åˆ¥å§”å±ˆï¼Ÿ</li>
        </ul>
      </div>

      <div class="tip-card">
        <h3>å¦‚æœå¿ƒæƒ…å¾ˆä¸å¥½æ€éº¼è¾¦ï¼Ÿ</h3>
        <ul class="tip-list">
          <li>å…ˆæ·±å‘¼å¸å¹¾æ¬¡ï¼Œè®“è‡ªå·±æ…¢ä¸€é»ã€‚</li>
          <li>æŠŠæ„Ÿå—æ‰“å‡ºä¾†ï¼Œæ…¢æ…¢èªªçµ¦æ­æ–¯è½ã€‚</li>
          <li>ä¹‹å¾Œè©¦è‘—æ‰¾ä¸€ä½ä½ ä¿¡ä»»çš„å¤§äººèŠèŠã€‚</li>
        </ul>
      </div>

      <div class="tip-card">
        <h3>å®‰å…¨æé†’</h3>
        <p style="margin: 4px 0;">
          å¦‚æœä½ æœ‰æƒ³å‚·å®³è‡ªå·±ã€æƒ³æ¶ˆå¤±ã€æˆ–è¢«åˆ¥äººå‚·å®³çš„å¿µé ­ï¼Œ
          æ­æ–¯æœƒè«‹ä½ ä¸€å®šè¦ç«‹åˆ»æ‰¾è€å¸«æˆ–å®¶äººå¹«å¿™ã€‚
          å› ç‚ºçœŸæ­£åœ¨ä½ èº«é‚Šçš„å¤§äººï¼Œæ‰èƒ½çœŸæ­£ä¿è­·ä½ ã€‚
        </p>
      </div>

      <div class="footer-note">
        æœ¬æœå‹™åƒ…ä¾›æ ¡åœ’æƒ…ç·’æ”¯æŒä½¿ç”¨ï¼Œç„¡é†«ç™‚æˆ–å°ˆæ¥­å¿ƒç†æ²»ç™‚åŠŸèƒ½ã€‚<br>
        å¦‚é‡ç·Šæ€¥æˆ–å±éšªæƒ…æ³ï¼Œè«‹ç«‹å³å°‹æ±‚çœŸäººå”åŠ©ã€‚
      </div>
    </div>
  </div>

  <!-- æš±ç¨±å½ˆçª— -->
  <div id="nickname-modal">
    <div class="modal-inner">
      <p>å—¨ï¼æˆ‘æ˜¯ ğŸ¦‰ æ­æ–¯</p>
      <p>æˆ‘å¯ä»¥æ€éº¼ç¨±å‘¼ä½ å‘¢ï¼Ÿ</p>
      <input id="nickname-input" type="text" placeholder="è¼¸å…¥æš±ç¨±ï¼ˆä¾‹å¦‚ï¼šå°æ¨¹ï¼‰">
      <button id="save-nickname">é–‹å§‹èŠå¤©</button>
    </div>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const anonIdLabel = document.getElementById("anon-id-label");
    const nicknameLabel = document.getElementById("nickname-label");

    const nicknameModal = document.getElementById("nickname-modal");
    const nicknameInput = document.getElementById("nickname-input");
    const saveNicknameBtn = document.getElementById("save-nickname");

    // ===== åŒ¿åä»£è™Ÿï¼ˆOwl#123ï¼‰ =====
    function generateAnonId() {
      const num = Math.floor(100 + Math.random() * 900); // 100â€“999
      return `Owl#${num}`;
    }

    let anonId = localStorage.getItem("owlsense_anon_id");
    if (!anonId) {
      anonId = generateAnonId();
      localStorage.setItem("owlsense_anon_id", anonId);
    }
    anonIdLabel.textContent = `åŒ¿åä»£è™Ÿï¼š${anonId}`;

    // ===== æš±ç¨±æ©Ÿåˆ¶ =====
    let nickname = localStorage.getItem("owlsense_nickname");

    function updateNicknameLabel() {
      if (nickname && nickname.trim() !== "") {
        nicknameLabel.textContent = `æš±ç¨±ï¼š${nickname}`;
      } else {
        nicknameLabel.textContent = "æš±ç¨±ï¼šå°šæœªè¨­å®š";
      }
    }

    updateNicknameLabel();

    if (!nickname) {
      nicknameModal.style.display = "flex";
    } else {
      nicknameModal.style.display = "none";
    }

    saveNicknameBtn.addEventListener("click", () => {
      const value = nicknameInput.value.trim();
      if (!value) {
        alert("è«‹å…ˆè¼¸å…¥ä¸€å€‹æš±ç¨±å–”ï¼");
        return;
      }
      nickname = value;
      localStorage.setItem("owlsense_nickname", nickname);
      updateNicknameLabel();
      nicknameModal.style.display = "none";
    });

    function addMessage(text, sender) {
      const row = document.createElement("div");
      row.className = "message-row " + (sender === "user" ? "user" : "bot");

      const wrapper = document.createElement("div");
      const bubble = document.createElement("div");
      bubble.className =
        "bubble " + (sender === "user" ? "user-bubble" : "bot-bubble");
      bubble.textContent = text;

      const meta = document.createElement("div");
      meta.className = "bubble-meta";
      meta.textContent = sender === "user" ? (nickname || "ä½ ") : "æ­æ–¯";

      wrapper.appendChild(bubble);
      wrapper.appendChild(meta);
      row.appendChild(wrapper);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      // è‹¥é‚„æ²’è¨­å®šæš±ç¨±ï¼Œå°±è«‹å­¸ç”Ÿå…ˆè™•ç†æš±ç¨±
      if (!nickname || nickname.trim() === "") {
        alert("å…ˆå¹«è‡ªå·±å–ä¸€å€‹æš±ç¨±ï¼Œæ­æ–¯æ‰çŸ¥é“æ€éº¼ç¨±å‘¼ä½ å–”ï¼");
        nicknameModal.style.display = "flex";
        return;
      }

      addMessage(text, "user");
      userInput.value = "";
      userInput.focus();

      sendBtn.disabled = true;
      sendBtn.textContent = "æ­æ–¯æ€è€ƒä¸­â€¦";

      try {
        const resp = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: text,
            anon_id: anonId,
            nickname: nickname
          }),
        });

        const data = await resp.json();
        addMessage(data.reply || "æ­æ–¯é€™æ¬¡å¥½åƒæ²’æœ‰è½æ¸…æ¥šï¼Œå¯ä»¥å†èªªä¸€æ¬¡å—ï¼Ÿ", "bot");
      } catch (err) {
        addMessage("é€£ç·šå¥½åƒå‡ºäº†ä¸€é»å•é¡Œï¼Œå¯ä»¥ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚", "bot");
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "å‚³çµ¦æ­æ–¯";
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // å³å´æ¨™ç±¤é»ä¸€ä¸‹å¿«é€Ÿè¼¸å…¥
    document.querySelectorAll(".tag").forEach(tag => {
      tag.addEventListener("click", () => {
        userInput.value = tag.textContent.trim();
        userInput.focus();
      });
    });
  </script>
</body>
</html>
